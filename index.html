<script>
  const BACKEND = "https://cine-app-otdv.onrender.com";

  const chat = document.getElementById("chat");
  const form = document.getElementById("form");
  const textInput = document.getElementById("text");
  const modeSelect = document.getElementById("mode");
  const hint = document.getElementById("hint");
  const backendUrl = document.getElementById("backendUrl");

  backendUrl.textContent = BACKEND;

  function addMessageText(text, side = "left") {
    const div = document.createElement("div");
    div.className =
      side === "right"
        ? "align-self-end bg-primary text-white rounded-4 p-3"
        : "align-self-start bg-white border rounded-4 p-3";

    div.style.maxWidth = "80%";
    div.innerText = text;
    chat.appendChild(div);

    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function addMessageHtml(html, side = "left") {
    const div = document.createElement("div");
    div.className =
      side === "right"
        ? "align-self-end bg-primary text-white rounded-4 p-3"
        : "align-self-start bg-white border rounded-4 p-3";

    div.style.maxWidth = "80%";
    div.innerHTML = html;
    chat.appendChild(div);

    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  modeSelect.addEventListener("change", () => {
    hint.innerText =
      modeSelect.value === "movie"
        ? "EscribÃ­ una pelÃ­cula (ej: The Godfather)"
        : "EscribÃ­ un actor (ej: Leonardo DiCaprio)";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const text = textInput.value.trim();
    if (!text) return;

    const mode = modeSelect.value;
    textInput.value = "";

    addMessageText(text, "right");
    addMessageText("â³ Buscando...", "left");

    try {
      const res = await fetch(BACKEND + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode, text }),
      });

      const data = await res.json();
      chat.lastChild.remove(); // remove "Buscando..."

      if (!res.ok || data.ok === false) {
        addMessageText("âŒ Error: " + (data.error || "Error desconocido"), "left");
        return;
      }

      // Caso actor con filmografÃ­a
      if (data.mode === "actor" && Array.isArray(data.movies) && data.movies.length > 0) {
        const lines = data.movies
          .slice(0, 100)
          .map((m) => `â€¢ ${m.title} (${m.year})`)
          .join("<br>");

        const html = `
          <div class="fw-semibold mb-2">
            ğŸ­ FilmografÃ­a de ${data.actor} (hasta 100)
          </div>
          <div>${lines}</div>
        `;

        addMessageHtml(html, "left");
        return;
      }

      // Caso pelÃ­cula o actor sin movies
      addMessageText(data.answer || "Sin respuesta", "left");

    } catch (err) {
      chat.lastChild?.remove();
      addMessageText("âŒ Error de conexiÃ³n con el backend", "left");
    }
  });
</script>


