<!-- ============================================================
index.html  (Frontend - Movie Assistant)
Objetivo:
- NO hardcodear saludo en HTML (primer mensaje viene del backend)
- Enviar mensajes al backend (/chat) y renderizar:
  - Mensaje del usuario (derecha)
  - Respuesta principal del bot (izquierda)
  - Mensajes adicionales del bot (izquierda, en burbujas separadas)
- Mantener session_id (para que el backend conserve el contexto)
============================================================ -->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Assistant</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    /* ============================================================
      ESTILOS GENERALES
      - Fondo: #0D1117
      - Contenedor chat: #151b23 + borde fino blanco
      - Burbuja izquierda: #262c36
    ============================================================ */
    body {
      background-color: #0D1117;
      color: #e5e7eb;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      padding: 18px 12px 8px 12px;
      text-align: center;
    }
    .title {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 42px;
      line-height: 1;
      margin: 0;
    }
    .subtitle {
      margin-top: 6px;
      color: #9aa4b2;
      font-size: 16px;
    }

    /* Layout principal */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* ‚úÖ CLAVE: permite que el √°rea de chat tenga altura real y scrollee */

      width: min(980px, calc(100% - 20px));
      margin: 0 auto;
      padding: 10px 0 14px 0;
    }


    /* Caja de chat */
    .chat-box {
      flex: 1;
      min-height: 0;  /* ‚úÖ refuerza el scroll interno en flex */
      overflow-y: auto;
      padding: 14px 14px 4px 14px;
      border-radius: 18px;

      background: #151b23;
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    /* Burbuja */
    .bubble {
      display: block;               /* ‚úÖ 1 fila por mensaje */
      width: fit-content;           /* ‚úÖ ancho seg√∫n texto */
      max-width: min(78%, 620px);   /* ‚úÖ l√≠mite para textos largos */

      padding: 12px 14px;
      border-radius: 16px;
      margin: 10px 0;

      white-space: pre-wrap;
      overflow-wrap: anywhere;
      line-height: 1.25rem;

      border: 1px solid rgba(255,255,255,0.07);
    }

    /* Bot (izquierda) */
    .bubble.bot {
      background: #262c36;
      color: #e5e7eb;
      margin-right: auto;
      border-top-left-radius: 6px;
    }

    /* Usuario (derecha) */
    .bubble.user {
      background: #0f766e; /* verde/teal */
      color: #eaffff;
      margin-left: auto;
      border-top-right-radius: 6px;
      border-color: rgba(0,0,0,0.12);
    }

    /* Burbuja "pensando" (con reloj) */
    .bubble.loading {
      opacity: 0.85;
      font-style: italic;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); opacity: 0.7; }
    }
    .bubble.loading .clock {
      display: inline-block;
      animation: pulse 1s infinite;
    }

    /* Barra inferior: input + send */
    .composer {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .composer .badge-area {
      flex: 0 0 auto;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: #d8dee9;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      user-select: none;
    }
    .composer input {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: #e5e7eb;
      padding: 12px 14px;
      border-radius: 12px;
      outline: none;
    }
    .composer input::placeholder { color: #98a2b3; }

    .btn-send {
      background: #0b3a66; /* azul m√°s oscuro para "Enviar" */
      border: 1px solid rgba(255,255,255,0.10);
      color: #e5e7eb;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
    }
    .btn-send:hover { filter: brightness(1.08); }

    /* Peque√±o indicador (legacy) */
    .typing {
      opacity: 0.8;
      font-size: 13px;
      color: #9aa4b2;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- ============================================================
      HEADER
    ============================================================ -->
    <div class="header">
      <h1 class="title">üé¨ Movie Assistant</h1>
      <div class="subtitle">¬øHablamos de cine? ¬øQu√© te gustar√≠a saber?</div>
    </div>

    <!-- ============================================================
      CONTENIDO
      - chat-box (scroll)
      - composer (input)
    ============================================================ -->
    <div class="content">

      <div id="chatBox" class="chat-box">
        <!-- ‚úÖ Sin saludo hardcodeado -->
      </div>

      <div class="composer">
        <div class="badge-area">Agentic AI + buscador</div>

        <input
          id="userInput"
          type="text"
          placeholder="Escrib√≠ ac√°‚Ä¶"
          autocomplete="off"
        />

        <button id="sendBtn" class="btn-send">Enviar</button>
      </div>

      <!-- Legacy (no se usa; queda apagado por setThinking) -->
      <div id="typing" class="typing" style="display:none;">‚è≥ Pensando‚Ä¶</div>
    </div>
  </div>

  <script>
    /* ============================================================
      CONFIG
      - API_BASE debe apuntar al backend de Render (equivalente a tu viejo API_URL)
    ============================================================ */

    const API_BASE = "https://cine-app-otdv.onrender.com";

    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const typing = document.getElementById("typing");

    /* ============================================================
      Session handling
      - Guardamos session_id para que el backend mantenga contexto.
    ============================================================ */
    function getSessionId() {
      return localStorage.getItem("movie_assistant_session_id") || "";
    }
    function setSessionId(sid) {
      if (sid) localStorage.setItem("movie_assistant_session_id", sid);
    }

    /* ============================================================
      UI helpers
    ============================================================ */
    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addBubble(text, who) {
      const div = document.createElement("div");
      div.className = "bubble " + (who === "user" ? "user" : "bot");
      div.textContent = text || "";
      chatBox.appendChild(div);
      scrollToBottom();
    }

    // Burbuja "pensando" dentro del chat (estilo WhatsApp)
    let loadingBubble = null;

    function showLoadingBubble() {
      if (loadingBubble) return; // evita duplicados

      loadingBubble = document.createElement("div");
      loadingBubble.className = "bubble bot loading";
      loadingBubble.innerHTML = '<span class="clock">‚è≥</span> Pensando...';
      chatBox.appendChild(loadingBubble);
      scrollToBottom();
    }

    function hideLoadingBubble() {
      if (loadingBubble) {
        loadingBubble.remove();
        loadingBubble = null;
      }
    }

    function setThinking(on) {
      // Mostramos una burbuja con reloj mientras esperamos la respuesta
      if (on) showLoadingBubble();
      else hideLoadingBubble();

      // Mantenemos el indicador viejo apagado (por si lo quer√©s reutilizar)
      typing.style.display = "none";
    }

    /* ============================================================
      INIT (primer mensaje desde backend)
      - Enviamos "__INIT__" para que Python devuelva el saludo inicial
    ============================================================ */
    async function initConversation() {
      setThinking(true);
      try {
        const sid = getSessionId();
        const resp = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(sid ? { "X-Session-Id": sid } : {})
          },
          body: JSON.stringify({ mode: "consultas", text: "__INIT__" })
        });

        if (!resp.ok) {
          addBubble("‚ùå Error de conexi√≥n con la API.", "bot");
          return;
        }

        const data = await resp.json();
        if (data && data.session_id) setSessionId(data.session_id);

        if (data && typeof data.answer === "string" && data.answer.trim()) {
          addBubble(data.answer, "bot");
        }
        if (data && Array.isArray(data.messages)) {
          data.messages.forEach(m => {
            if (typeof m === "string" && m.trim()) addBubble(m, "bot");
          });
        }
      } catch (e) {
        addBubble("‚ùå Error de conexi√≥n con la API.", "bot");
      } finally {
        setThinking(false);
      }
    }

    /* ============================================================
      CALL BACKEND
      - Env√≠a texto del usuario a POST /chat
      - Renderiza:
        res.answer (principal)
        res.messages[] (burbujas extra)
    ============================================================ */
    async function sendMessage() {
      const text = (userInput.value || "").trim();
      if (!text) return;

      addBubble(text, "user");
      userInput.value = "";
      setThinking(true);

      try {
        const sid = getSessionId();
        const resp = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(sid ? { "X-Session-Id": sid } : {})
          },
          body: JSON.stringify({ mode: "consultas", text })
        });

        if (!resp.ok) {
          addBubble("‚ùå Error de conexi√≥n con la API.", "bot");
          setThinking(false);
          return;
        }

        const data = await resp.json();

        if (data && data.session_id) setSessionId(data.session_id);

        if (data && typeof data.answer === "string" && data.answer.trim()) {
          addBubble(data.answer, "bot");
        }

        if (data && Array.isArray(data.messages)) {
          data.messages.forEach(m => {
            if (typeof m === "string" && m.trim()) addBubble(m, "bot");
          });
        }

      } catch (e) {
        addBubble("‚ùå Error de conexi√≥n con la API.", "bot");
      } finally {
        setThinking(false);
      }
    }

    /* ============================================================
      EVENTOS
    ============================================================ */
    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Focus inicial + init
    userInput.focus();
    window.addEventListener("load", initConversation);
  </script>
</body>
</html>
