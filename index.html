<!-- ============================================================
index.html  (Frontend - Movie Assistant)
Objetivo:
- NO hardcodear saludo en HTML (primer mensaje viene del backend)
- Enviar mensajes al backend /chat
- Renderizar mÃºltiples burbujas (answer + messages[])
- Scroll tipo WhatsApp (chatBox con overflow-y:auto)
============================================================ -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Movie Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #0D1117;
      color: #e5e7eb;
      height: 100vh;
      margin: 0;
      overflow: hidden; /* evita scroll del body; scrollea el chatBox */
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      padding: 1.5rem;
      text-align: center;
    }

    .title {
      font-size: 3rem;
      font-weight: 800;
      line-height: 1.1;
    }

    .subtitle {
      margin-top: 0.25rem;
      color: #9aa4b2;
      font-size: 1.25rem;
    }

    /* Contenedor principal (rectÃ¡ngulo grande) */
    .chat-container {
      flex: 1;
      margin: 0 1rem 1rem;
      background: #151b23;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* el scroll va dentro del chatBox */
    }

    /* Zona de mensajes: scrollea */
    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .bubble {
      max-width: 78%;
      padding: 12px 14px;
      border-radius: 16px;
      margin: 8px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.35;
    }

    .bot {
      background: #262c36;
      color: #e5e7eb;
      align-self: flex-start;
    }

    .user {
      background: #0f766e;
      color: white;
      align-self: flex-end;
    }

    /* barra inferior */
    .input-bar {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      align-items: center;
    }

    .brand-pill {
      background: #0b3c6f;
      color: #cfe7ff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.9rem;
      border: 1px solid rgba(255,255,255,0.15);
      user-select: none;
      white-space: nowrap;
    }

    #userInput {
      flex: 1;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: #0f1720;
      color: #e5e7eb;
      padding: 10px 12px;
      outline: none;
    }

    #sendBtn {
      background: #0b3c6f;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 10px;
      padding: 10px 14px;
      color: #e5e7eb;
      font-weight: 600;
    }

    #sendBtn:hover {
      filter: brightness(1.06);
    }

    #typing {
      display: none;
      color: #9aa4b2;
      margin-left: 0.5rem;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div class="title">ðŸŽ¬ Movie Assistant</div>
      <div class="subtitle">Â¿Hablamos de cine? Â¿QuÃ© te gustarÃ­a saber?</div>
    </div>

    <div class="chat-container">
      <div id="chatBox"></div>

      <div class="input-bar">
        <div class="brand-pill">Agentic AI + buscador</div>
        <input id="userInput" type="text" placeholder="EscribÃ­ acÃ¡..." autocomplete="off" />
        <button id="sendBtn">Enviar</button>
        <span id="typing">Escribiendo...</span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://cine-app-otdv.onrender.com";

    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const typing = document.getElementById("typing");

    // ============================================================
    // INIT guard (evita mensajes duplicados por doble carga)
    // ============================================================
    let initStarted = false;
    let initDone = false;

    /* ============================================================
      Session handling
      - Guardamos session_id en localStorage
      - Se envÃ­a en el header X-Session-Id
    ============================================================ */
    function getSessionId() {
      return localStorage.getItem("movie_assistant_session_id") || "";
    }
    function setSessionId(sid) {
      if (sid) localStorage.setItem("movie_assistant_session_id", sid);
    }

    /* ============================================================
      UI helpers
    ============================================================ */
    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addBubble(text, who) {
      const div = document.createElement("div");
      div.className = `bubble ${who}`;
      div.textContent = text;
      chatBox.appendChild(div);
      scrollToBottom();
    }

    // Loading bubble (reloj)
    let loadingEl = null;
    function showLoadingBubble() {
      if (loadingEl) return;
      loadingEl = document.createElement("div");
      loadingEl.className = "bubble bot";
      loadingEl.textContent = "ðŸ•’ ...";
      chatBox.appendChild(loadingEl);
      scrollToBottom();
    }
    function hideLoadingBubble() {
      if (!loadingEl) return;
      loadingEl.remove();
      loadingEl = null;
    }

    function setThinking(on) {
      if (on) showLoadingBubble();
      else hideLoadingBubble();
      typing.style.display = "none";
    }

    /* ============================================================
      INIT (primer mensaje desde backend)
      - Enviamos "__INIT__" para que Python devuelva el saludo inicial
    ============================================================ */
    async function initConversation() {
      // Evita que el init se ejecute mÃ¡s de una vez
      if (initStarted) return;
      initStarted = true;

      setThinking(true);
      try {
        const sid = getSessionId();
        const resp = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(sid ? { "X-Session-Id": sid } : {})
          },
          body: JSON.stringify({ mode: "consultas", text: "__INIT__" })
        });

        if (!resp.ok) {
          addBubble("âŒ Error de conexiÃ³n con la API.", "bot");
          return;
        }

        const data = await resp.json();
        if (data && data.session_id) setSessionId(data.session_id);

        if (data && typeof data.answer === "string" && data.answer.trim()) {
          addBubble(data.answer, "bot");
        }
        if (data && Array.isArray(data.messages)) {
          data.messages.forEach(m => {
            if (typeof m === "string" && m.trim()) addBubble(m, "bot");
          });
        }
      } catch (e) {
        addBubble("âŒ Error de conexiÃ³n con la API.", "bot");
      } finally {
        setThinking(false);
        initDone = true;
      }
    }

    /* ============================================================
      SEND
    ============================================================ */
    async function sendMessage() {
      // Evita enviar mensajes mientras el init todavÃ­a no terminÃ³
      if (!initDone) return;

      const text = (userInput.value || "").trim();
      if (!text) return;

      addBubble(text, "user");
      userInput.value = "";
      setThinking(true);

      try {
        const sid = getSessionId();
        const resp = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(sid ? { "X-Session-Id": sid } : {})
          },
          body: JSON.stringify({ mode: "consultas", text })
        });

        if (!resp.ok) {
          addBubble("âŒ Error de conexiÃ³n con la API.", "bot");
          return;
        }

        const data = await resp.json();
        if (data && data.session_id) setSessionId(data.session_id);

        if (data && typeof data.answer === "string" && data.answer.trim()) {
          addBubble(data.answer, "bot");
        }
        if (data && Array.isArray(data.messages)) {
          data.messages.forEach(m => {
            if (typeof m === "string" && m.trim()) addBubble(m, "bot");
          });
        }
      } catch (e) {
        addBubble("âŒ Error de conexiÃ³n con la API.", "bot");
      } finally {
        setThinking(false);
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    addEventListener("load", initConversation);
  </script>
</body>
</html>
