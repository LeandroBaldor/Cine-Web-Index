<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cine Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

  <!-- Header -->
  <nav class="navbar bg-white border-bottom">
    <div class="container-fluid px-3 px-md-4">
      <div class="d-flex align-items-center gap-2">
        <span class="badge text-bg-primary">üé¨</span>
        <span class="navbar-brand mb-0 h1 fw-semibold">Cine Assistant</span>
      </div>
      <span class="badge rounded-pill text-bg-secondary">Demo</span>
    </div>
  </nav>

  <div class="container-fluid px-3 px-md-4 py-3">

    <!-- Card principal -->
    <div class="card border-0 shadow-sm">
      <div class="card-body">

        <!-- Backend -->
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
          <div class="small text-muted">
            Backend: <code id="backendUrl"></code>
          </div>
          <div class="d-flex gap-2">
            <a id="openDocs" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noreferrer">Docs</a>
            <button id="clearBtn" class="btn btn-sm btn-outline-danger">Limpiar</button>
          </div>
        </div>

        <!-- Selector modo -->
        <div class="row g-2 align-items-center mb-3">
          <div class="col-12 col-md-3">
            <select id="mode" class="form-select">
              <option value="movie" selected>üé¨ Pel√≠cula</option>
              <option value="actor">üé≠ Actor</option>
            </select>
          </div>
          <div class="col-12 col-md-9">
            <div class="alert alert-info mb-0 py-2">
              <span id="hint">
                Escrib√≠ una pel√≠cula (ej: <b>The Godfather</b>) y te devuelvo a√±o, director, actores, IMDb y pa√≠s.
              </span>
            </div>
          </div>
        </div>

        <!-- Chat area -->
        <div id="chat" class="d-flex flex-column gap-2" style="min-height: 45vh;">
          <!-- Mensaje inicial -->
          <div class="d-flex">
            <div class="p-3 rounded-4 bg-white border w-100">
              üëã Hola. Eleg√≠ <b>Pel√≠cula</b> o <b>Actor</b> y escrib√≠ abajo.
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Composer (abajo) -->
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-body">
        <form id="form" class="row g-2 align-items-center">
          <div class="col-12 col-md-10">
            <input id="text" class="form-control form-control-lg" placeholder="Escrib√≠ ac√°..." autocomplete="off" />
          </div>
          <div class="col-12 col-md-2 d-grid">
            <button id="sendBtn" class="btn btn-primary btn-lg" type="submit">Enviar</button>
          </div>
        </form>
        <div class="small text-muted mt-2">
          Tip: prob√° <b>Zodiac</b> en Pel√≠cula o <b>Leonardo DiCaprio</b> en Actor.
        </div>
      </div>
    </div>

  </div>

  <script>
    // ‚úÖ Tu backend Render:
    const BACKEND = "https://cine-app-otdv.onrender.com";

    const backendUrlEl = document.getElementById("backendUrl");
    const openDocsEl = document.getElementById("openDocs");
    const chatEl = document.getElementById("chat");
    const formEl = document.getElementById("form");
    const textEl = document.getElementById("text");
    const modeEl = document.getElementById("mode");
    const hintEl = document.getElementById("hint");
    const clearBtn = document.getElementById("clearBtn");

    backendUrlEl.textContent = BACKEND;
    openDocsEl.href = BACKEND + "/docs";

    function addBubble({ side, html }) {
      // side: "left" (assistant) | "right" (user)
      const row = document.createElement("div");
      row.className = "d-flex " + (side === "right" ? "justify-content-end" : "");

      const bubble = document.createElement("div");
      bubble.className = "p-3 rounded-4 " + (side === "right"
        ? "bg-primary text-white"
        : "bg-white border");
      bubble.style.maxWidth = "780px";
      bubble.innerHTML = html;

      row.appendChild(bubble);
      chatEl.appendChild(row);

      // scroll abajo
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function setHint() {
      const m = modeEl.value;
      if (m === "movie") {
        hintEl.innerHTML = 'Escrib√≠ una pel√≠cula (ej: <b>The Godfather</b>) y te devuelvo a√±o, director, actores, IMDb y pa√≠s.';
        textEl.placeholder = "Ej: The Godfather, Zodiac, Parasite...";
      } else {
        hintEl.innerHTML = 'Escrib√≠ un actor (ej: <b>Leonardo DiCaprio</b>) y te devuelvo una lista de pel√≠culas + a√±o (requiere TMDB_API_KEY en el backend).';
        textEl.placeholder = "Ej: Leonardo DiCaprio, Brad Pitt...";
      }
    }

    modeEl.addEventListener("change", setHint);
    setHint();

    clearBtn.addEventListener("click", () => {
      chatEl.innerHTML = "";
      addBubble({ side: "left", html: "üßπ Listo, chat limpio." });
      textEl.focus();
    });

    async function send(mode, text) {
      // user bubble
      addBubble({ side: "right", html: escapeHtml(text) });

      // loading bubble
      const loadingId = "loading-" + Date.now();
      addBubble({ side: "left", html: `<span id="${loadingId}">‚è≥ Buscando...</span>` });

      try {
        const res = await fetch(BACKEND + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode, text })
        });

        const data = await res.json();

        // reemplazar loading
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.parentElement.innerHTML = "";

        if (!res.ok || data.ok === false) {
          const msg = escapeHtml(data?.error || `Error HTTP ${res.status}`);
          addBubble({ side: "left", html: `‚ùå ${msg}` });
          return;
        }

        // Respuesta
        if (data.answer) {
          addBubble({ side: "left", html: `<pre class="mb-0" style="white-space:pre-wrap;">${escapeHtml(data.answer)}</pre>` });
        } else {
          addBubble({ side: "left", html: "‚úÖ OK (sin mensaje)" });
        }

      } catch (e) {
        // reemplazar loading
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.parentElement.innerHTML = "";
        addBubble({ side: "left", html: `‚ùå Failed to fetch` });
      }
    }

    formEl.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const text = textEl.value.trim();
      if (!text) return;

      const mode = modeEl.value;
      textEl.value = "";
      await send(mode, text);
      textEl.focus();
    });
  </script>
</body>
</html>
