<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cine Assistant</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>

<body class="bg-light d-flex flex-column" style="min-height:100vh;">

  <!-- Header -->
  <nav class="navbar bg-white border-bottom px-3">
    <span class="navbar-brand fw-semibold">
      ğŸ¬ Cine Assistant
    </span>
    <span class="badge bg-secondary">Demo</span>
  </nav>

  <!-- Chat container -->
  <main class="container my-3 flex-grow-1 d-flex flex-column">
    <div id="chat" class="flex-grow-1 d-flex flex-column gap-2">
      <div class="align-self-start bg-white border rounded-4 p-3">
        ğŸ‘‹ Hola. ElegÃ­ <b>PelÃ­cula</b> o <b>Actor</b> y escribÃ­ abajo.
      </div>
    </div>
  </main>

  <!-- Input area -->
  <footer class="bg-white border-top p-3">
    <div class="container">
      <div class="row g-2 align-items-center mb-2">
        <div class="col-12 col-md-3">
          <select id="mode" class="form-select">
            <option value="movie" selected>ğŸ¬ PelÃ­cula</option>
            <option value="actor">ğŸ­ Actor</option>
          </select>
        </div>
        <div class="col-12 col-md-9">
          <small class="text-muted" id="hint">
            EscribÃ­ una pelÃ­cula (ej: The Godfather)
          </small>
        </div>
      </div>

      <form id="form" class="row g-2">
        <div class="col-12 col-md-10">
          <input
            id="text"
            class="form-control form-control-lg"
            placeholder="EscribÃ­ acÃ¡..."
            autocomplete="off"
          />
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-primary btn-lg" type="submit">
            Enviar
          </button>
        </div>
      </form>

      <div class="small text-muted mt-2">
        Backend: <code id="backendUrl"></code>
      </div>
    </div>
  </footer>

  <script>
    // ğŸ‘‰ URL de tu backend en Render
    const BACKEND = "https://cine-app-otdv.onrender.com";

    const chat = document.getElementById("chat");
    const form = document.getElementById("form");
    const textInput = document.getElementById("text");
    const modeSelect = document.getElementById("mode");
    const hint = document.getElementById("hint");
    const backendUrl = document.getElementById("backendUrl");

    backendUrl.textContent = BACKEND;

function addMessageText(text, side = "left") {
  const div = document.createElement("div");
  div.className =
    side === "right"
      ? "align-self-end bg-primary text-white rounded-4 p-3"
      : "align-self-start bg-white border rounded-4 p-3";

  div.style.maxWidth = "80%";
  div.innerText = text;
  chat.appendChild(div);

  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

function addMessageHtml(html, side = "left") {
  const div = document.createElement("div");
  div.className =
    side === "right"
      ? "align-self-end bg-primary text-white rounded-4 p-3"
      : "align-self-start bg-white border rounded-4 p-3";

  div.style.maxWidth = "80%";
  div.innerHTML = html;
  chat.appendChild(div);

  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}


    modeSelect.addEventListener("change", () => {
      if (modeSelect.value === "movie") {
        hint.innerText = "EscribÃ­ una pelÃ­cula (ej: The Godfather)";
      } else {
        hint.innerText = "EscribÃ­ un actor (ej: Leonardo DiCaprio)";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const text = textInput.value.trim();
      if (!text) return;

      const mode = modeSelect.value;
      textInput.value = "";

      addMessageText(text, "right") ;
      addMessageText("â³ Buscando...", "left");

      try {
        const res = await fetch(BACKEND + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode, text })
        });

        const data = await res.json();

        // borrar el "Buscando..."
        chat.lastChild.remove();

        if (!res.ok || data.ok === false) {
          addMessage("âŒ Error: " + (data.error || "Error desconocido"));
          return;
        }

        // Si es actor y viene lista de movies -> mostramos 10 + "Ver mÃ¡s"
if (data.mode === "actor" && Array.isArray(data.movies) && data.movies.length > 0) {
  const first = data.movies.slice(0, 10);
  const rest = data.movies.slice(10);

  const firstLines = first.map(m => `â€¢ ${m.title} (${m.year})`).join("<br>");
  const restLines = rest.map(m => `â€¢ ${m.title} (${m.year})`).join("<br>");

  const id = "more-" + Date.now();

  let html = `<div class="fw-semibold mb-2">ğŸ­ FilmografÃ­a de ${data.actor || data.movie?.actor || ""}</div>`;
  html += `<div>${firstLines}</div>`;

  if (rest.length > 0) {
    html += `
      <div class="mt-2">
        <button class="btn btn-sm btn-outline-primary" id="${id}-btn">Ver mÃ¡s (${rest.length})</button>
      </div>
      <div class="mt-2 d-none" id="${id}-panel">${restLines}</div>
    `;
  }

  addMessageHtml(html, "left");

  // Activar botÃ³n "Ver mÃ¡s"
  if (rest.length > 0) {
    const btn = document.getElementById(`${id}-btn`);
    const panel = document.getElementById(`${id}-panel`);
    btn.addEventListener("click", () => {
      panel.classList.toggle("d-none");
      btn.innerText = panel.classList.contains("d-none") ? `Ver mÃ¡s (${rest.length})` : "Ver menos";
    });
  }

} else {
  // default (pelÃ­cula o actor sin movies)
  addMessageText(data.answer || "Sin respuesta", "left");
}

      } catch (err) {
        chat.lastChild.remove();
        addMessage("âŒ Error de conexiÃ³n con el backend");
      }
    });
  </script>

</body>
</html>


