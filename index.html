<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cine Assistant</title>

  <!-- Bootstrap 5 (sin CSS propio) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4" style="max-width: 820px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 m-0">üé¨ Cine Assistant</h1>
      <span class="badge text-bg-secondary">Demo</span>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div id="chat" class="d-flex flex-column gap-2" style="min-height: 320px; max-height: 520px; overflow:auto;">
          <div class="alert alert-info mb-0">
            Escrib√≠ una pel√≠cula o una pregunta (por ejemplo: <b>The Godfather</b>, <b>y el rating?</b>)
          </div>
        </div>
      </div>
    </div>

    <form id="form" class="card shadow-sm">
      <div class="card-body">
        <div class="input-group">
          <input id="input" class="form-control" placeholder="Escrib√≠ ac√°..." autocomplete="off" />
          <button id="send" class="btn btn-primary" type="submit">Enviar</button>
        </div>
        <div class="form-text mt-2">
          Backend: <code id="backendUrl"></code>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ‚úÖ TU BACKEND EN RENDER (producci√≥n)
    const API_BASE = "https://cine-app-otdv.onrender.com";
    document.getElementById("backendUrl").textContent = API_BASE;

    // sesi√≥n simple para memoria (se mantiene mientras no recargues)
    const sessionId = "web-" + Math.random().toString(16).slice(2);

    const chatEl = document.getElementById("chat");
    const formEl = document.getElementById("form");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function addBubble(role, text) {
      const wrap = document.createElement("div");
      wrap.className = "d-flex " + (role === "user" ? "justify-content-end" : "justify-content-start");

      const bubble = document.createElement("div");
      bubble.className = "p-2 rounded-3 " + (role === "user" ? "bg-primary text-white" : "bg-white border");
      bubble.style.maxWidth = "90%";
      bubble.style.whiteSpace = "pre-wrap";
      bubble.textContent = text;

      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function ask(text) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, session_id: sessionId })
      });

      // si hay error HTTP, intentamos leer cuerpo para mostrarlo
      if (!res.ok) {
        let errText = `Error HTTP ${res.status}`;
        try {
          const j = await res.json();
          errText = j?.error || JSON.stringify(j);
        } catch (_) {}
        throw new Error(errText);
      }

      return res.json();
    }

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;

      addBubble("user", text);
      inputEl.value = "";
      inputEl.focus();

      sendBtn.disabled = true;
      const oldLabel = sendBtn.textContent;
      sendBtn.textContent = "Enviando...";

      try {
        const data = await ask(text);
        addBubble("assistant", data.answer || "(sin respuesta)");
      } catch (err) {
        addBubble("assistant", "‚ùå " + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = oldLabel;
      }
    });

    // UX: foco inicial
    inputEl.focus();
  </script>
</body>
</html>
