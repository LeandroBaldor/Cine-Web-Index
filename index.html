import os
import requests
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

# =========================
# Config
# =========================
OMDB_API_KEY = os.getenv("OMDB_API_KEY", "").strip()
OMDB_BASE = "https://www.omdbapi.com/"

app = FastAPI(title="Cine Assistant API (OMDb only)", version="1.0")

# CORS para GitHub Pages (tu sitio)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://leandrobaldor.github.io"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# =========================
# Schemas
# =========================
class ChatRequest(BaseModel):
    mode: str  # "movie" | "actor"
    text: str

# =========================
# Helpers: OMDb
# =========================
def omdb_get_movie(title: str) -> dict | None:
    if not OMDB_API_KEY:
        raise RuntimeError("Falta OMDB_API_KEY (variable de entorno en Render).")

    params = {
        "apikey": OMDB_API_KEY,
        "t": title,
        "plot": "short",
        "r": "json",
    }
    r = requests.get(OMDB_BASE, params=params, timeout=20)
    r.raise_for_status()
    data = r.json()

    if data.get("Response") != "True":
        return None

    return {
        "title": data.get("Title"),
        "year": data.get("Year"),
        "director": data.get("Director"),
        "actors": data.get("Actors"),
        "imdb_rating": data.get("imdbRating"),
        "country": data.get("Country"),
        "genre": data.get("Genre"),
        "plot": data.get("Plot"),
        "imdb_id": data.get("imdbID"),
        "poster": data.get("Poster"),
    }

def format_movie_answer(m: dict) -> str:
    return (
        f"üé¨ {m['title']} ({m['year']})\n"
        f"‚≠ê IMDb: {m['imdb_rating']}\n"
        f"üé¨ Director: {m['director']}\n"
        f"üë• Actores: {m['actors']}\n"
        f"üåç Pa√≠s: {m['country']}"
    )

# =========================
# Routes
# =========================
@app.get("/health")
def health():
    return {"ok": True}

@app.post("/chat")
def chat(req: ChatRequest):
    mode = (req.mode or "").strip().lower()
    text = (req.text or "").strip()

    if not text:
        return {"ok": False, "error": "Texto vac√≠o. Escrib√≠ una pel√≠cula o actor."}

    # ---- MODO PEL√çCULA ----
    if mode == "movie":
        try:
            m = omdb_get_movie(text)
        except Exception as e:
            # esto devuelve error claro si falta OMDB_API_KEY
            return {"ok": False, "error": str(e)}

        if not m:
            return {
                "ok": True,
                "mode": "movie",
                "found": False,
                "title": text,
                "answer": f"‚ùå No encontr√© la pel√≠cula '{text}'. Prob√° con otro t√≠tulo.",
                "movie": None,
            }

        return {
            "ok": True,
            "mode": "movie",
            "found": True,
            "title": m["title"],
            "answer": format_movie_answer(m),
            "movie": m,
        }

    # ---- MODO ACTOR ----
    if mode == "actor":
        # OMDb no soporta "filmograf√≠a por actor" directamente
        return {
            "ok": True,
            "mode": "actor",
            "found": False,
            "actor": text,
            "answer": (
                "‚ö†Ô∏è OMDb no permite buscar filmograf√≠a completa por actor.\n"
                "Si quer√©s que 'Ingresar actor' devuelva pel√≠culas, necesitamos usar otra fuente "
                "como TMDb (gratis) o un dataset de IMDb.\n"
                "Decime y lo habilitamos."
            ),
            "movies": [],
        }

    return {"ok": False, "error": "mode inv√°lido. Us√° 'movie' o 'actor'."}

